<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¹ MIDI ì¥ì¹˜ í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .device-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        .device-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .device-item h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        .device-info {
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        .test-btn {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <a href="/" class="back-btn">â† ë©”ë‰´ë¡œ</a>

    <div class="container">
        <header>
            <h1>ğŸ¹ MIDI ì¥ì¹˜ í…ŒìŠ¤íŠ¸</h1>
            <p class="subtitle">ì—°ê²°ëœ ëª¨ë“  MIDI ì¥ì¹˜ í™•ì¸ ë° í…ŒìŠ¤íŠ¸</p>
        </header>

        <div class="controls">
            <button onclick="refreshDevices()">ğŸ”„ ì¥ì¹˜ ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="testAllDevices()">ğŸµ ëª¨ë“  ì¥ì¹˜ í…ŒìŠ¤íŠ¸ (C4 ì¬ìƒ)</button>
            <button onclick="clearSavedDevice()" style="background: rgba(255, 100, 100, 0.3);">
                ğŸ—‘ï¸ ì €ì¥ëœ MIDI ì„¤ì • ì´ˆê¸°í™”
            </button>
        </div>

        <div class="status" id="savedDeviceStatus" style="margin-top: 10px; font-size: 0.9em;">
            ğŸ’¾ ì €ì¥ëœ ì¥ì¹˜: <span id="savedDeviceInfo">í™•ì¸ ì¤‘...</span>
        </div>

        <div class="status" id="status">ì´ˆê¸°í™” ì¤‘...</div>

        <div class="device-list">
            <h2>ğŸ“¤ MIDI ì¶œë ¥ ì¥ì¹˜</h2>
            <div id="outputList">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="device-list">
            <h2>ğŸ“¥ MIDI ì…ë ¥ ì¥ì¹˜</h2>
            <div id="inputList">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="controls" style="margin-top: 30px;">
            <h3>ğŸ’¡ ë¬¸ì œ í•´ê²° íŒ</h3>
            <ul style="text-align: left; max-width: 600px; margin: 10px auto; line-height: 1.8;">
                <li><strong>Microsoft GS Wavetable Synthê°€ ì•ˆ ë³´ì´ëŠ” ê²½ìš°:</strong>
                    <ul>
                        <li>Windows ì„¤ì • â†’ ì‹œìŠ¤í…œ â†’ ì‚¬ìš´ë“œ â†’ ê³ ê¸‰ ì‚¬ìš´ë“œ ì˜µì…˜ì—ì„œ í™•ì¸</li>
                        <li>ì¥ì¹˜ ê´€ë¦¬ìì—ì„œ "ì†Œí”„íŠ¸ì›¨ì–´ ì¥ì¹˜" í™•ì¸</li>
                        <li>ë¸Œë¼ìš°ì €ë¥¼ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ ì‹œë„</li>
                    </ul>
                </li>
                <li><strong>Stateê°€ 'disconnected'ì¸ ê²½ìš°:</strong>
                    <ul>
                        <li>ì¥ì¹˜ê°€ ë¬¼ë¦¬ì ìœ¼ë¡œ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸</li>
                        <li>ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì´ í•´ë‹¹ ì¥ì¹˜ë¥¼ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸</li>
                    </ul>
                </li>
                <li><strong>ì¥ì¹˜ê°€ ì „í˜€ ì•ˆ ë³´ì´ëŠ” ê²½ìš°:</strong>
                    <ul>
                        <li>Chrome/Edge ë¸Œë¼ìš°ì € ì‚¬ìš© í™•ì¸</li>
                        <li>ë¸Œë¼ìš°ì € í”Œë˜ê·¸ í™•ì¸: <code>chrome://flags/#enable-experimental-web-platform-features</code></li>
                        <li>ê°€ìƒ MIDI í¬íŠ¸ ì„¤ì¹˜ (loopMIDI)</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        let testNotes = new Set();

        // ì €ì¥ëœ ì¥ì¹˜ ì •ë³´ í‘œì‹œ
        function updateSavedDeviceInfo() {
            const savedId = localStorage.getItem('preferredMidiOutput');
            const infoEl = document.getElementById('savedDeviceInfo');

            if (!savedId) {
                infoEl.textContent = 'ì—†ìŒ (ìë™ ì„ íƒ)';
                infoEl.style.color = '#999';
            } else {
                infoEl.textContent = `ID: ${savedId}`;
                infoEl.style.color = '#4CAF50';
            }
        }

        // ì €ì¥ëœ ì„¤ì • ì´ˆê¸°í™”
        function clearSavedDevice() {
            const savedId = localStorage.getItem('preferredMidiOutput');

            if (!savedId) {
                showStatus('ì´ˆê¸°í™”í•  ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (confirm('ì €ì¥ëœ MIDI ì¥ì¹˜ ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¤ìŒ ì ‘ì† ì‹œ ìë™ìœ¼ë¡œ ì¥ì¹˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.')) {
                localStorage.removeItem('preferredMidiOutput');
                updateSavedDeviceInfo();
                showSuccess('ì €ì¥ëœ ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
                console.log('ğŸ—‘ï¸ localStorage.preferredMidiOutput ì‚­ì œë¨');
            }
        }

        async function refreshDevices() {
            showStatus('ì¥ì¹˜ ê²€ìƒ‰ ì¤‘...');

            try {
                // MIDI Access ìš”ì²­
                const access = await navigator.requestMIDIAccess({ sysex: false });

                // ì¶œë ¥ ì¥ì¹˜
                const outputs = Array.from(access.outputs.values());
                const outputList = document.getElementById('outputList');

                if (outputs.length === 0) {
                    outputList.innerHTML = '<p style="opacity: 0.6;">ì¶œë ¥ ì¥ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    outputList.innerHTML = outputs.map((output, idx) => `
                        <div class="device-item">
                            <h3>ğŸµ ${output.name}</h3>
                            <div class="device-info">
                                ID: ${output.id}<br>
                                Manufacturer: ${output.manufacturer || 'N/A'}<br>
                                State: <span style="color: ${output.state === 'connected' ? '#4CAF50' : '#F44336'}">${output.state}</span><br>
                                Connection: ${output.connection}<br>
                                Type: ${output.type || 'output'}
                            </div>
                            <button class="test-btn" onclick="testDevice('${output.id}')">
                                ğŸ¹ í…ŒìŠ¤íŠ¸ (C4 ì¬ìƒ)
                            </button>
                        </div>
                    `).join('');
                }

                // ì…ë ¥ ì¥ì¹˜
                const inputs = Array.from(access.inputs.values());
                const inputList = document.getElementById('inputList');

                if (inputs.length === 0) {
                    inputList.innerHTML = '<p style="opacity: 0.6;">ì…ë ¥ ì¥ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    inputList.innerHTML = inputs.map((input, idx) => `
                        <div class="device-item">
                            <h3>ğŸ¹ ${input.name}</h3>
                            <div class="device-info">
                                ID: ${input.id}<br>
                                Manufacturer: ${input.manufacturer || 'N/A'}<br>
                                State: <span style="color: ${input.state === 'connected' ? '#4CAF50' : '#F44336'}">${input.state}</span><br>
                                Connection: ${input.connection}<br>
                                Type: ${input.type || 'input'}
                            </div>
                        </div>
                    `).join('');
                }

                // ì½˜ì†”ì—ë„ ì¶œë ¥
                console.log('ğŸ“¤ MIDI ì¶œë ¥ ì¥ì¹˜:', outputs);
                console.log('ğŸ“¥ MIDI ì…ë ¥ ì¥ì¹˜:', inputs);

                showSuccess(`ì´ ${outputs.length}ê°œì˜ ì¶œë ¥ ì¥ì¹˜, ${inputs.length}ê°œì˜ ì…ë ¥ ì¥ì¹˜ ë°œê²¬`);

            } catch (error) {
                showError('MIDI ì¥ì¹˜ ê²€ìƒ‰ ì‹¤íŒ¨: ' + error.message);
                console.error(error);
            }
        }

        async function testDevice(deviceId) {
            try {
                const access = await navigator.requestMIDIAccess({ sysex: false });
                const output = access.outputs.get(deviceId);

                if (!output) {
                    showError('ì¥ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // C4 (MIDI note 60) ì¬ìƒ
                const note = 60;
                const velocity = 100;

                // Note On
                output.send([0x90, note, velocity]); // Channel 1
                testNotes.add(note);

                showSuccess(`${output.name}ì—ì„œ C4 ì¬ìƒ ì¤‘...`);

                // 1ì´ˆ í›„ Note Off
                setTimeout(() => {
                    output.send([0x80, note, 0]);
                    testNotes.delete(note);
                    showStatus('í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
                }, 1000);

            } catch (error) {
                showError('í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
                console.error(error);
            }
        }

        async function testAllDevices() {
            const access = await navigator.requestMIDIAccess({ sysex: false });
            const outputs = Array.from(access.outputs.values());

            showStatus(`${outputs.length}ê°œ ì¥ì¹˜ì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì¤‘...`);

            for (let i = 0; i < outputs.length; i++) {
                const output = outputs[i];
                console.log(`Testing ${i+1}/${outputs.length}: ${output.name}`);

                // C4 ì¬ìƒ
                output.send([0x90, 60, 100]);

                await new Promise(resolve => setTimeout(resolve, 500));

                // Note Off
                output.send([0x80, 60, 0]);

                await new Promise(resolve => setTimeout(resolve, 200));
            }

            showSuccess('ëª¨ë“  ì¥ì¹˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ê²€ìƒ‰
        window.addEventListener('load', () => {
            updateSavedDeviceInfo();
            refreshDevices();
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ëª¨ë“  ë…¸íŠ¸ ë„ê¸°
        window.addEventListener('beforeunload', () => {
            if (testNotes.size > 0) {
                navigator.requestMIDIAccess({ sysex: false }).then(access => {
                    access.outputs.forEach(output => {
                        testNotes.forEach(note => {
                            output.send([0x80, note, 0]);
                        });
                    });
                });
            }
        });
    </script>
</body>
</html>
